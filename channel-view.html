<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ù‚Ù†Ø§Ø©</title>

<style>

body{
    margin:0;
    font-family:Tahoma;
    background:#e5ddd5;
    display:flex;
    flex-direction:column;
    height:100vh;
}

/* Ø§Ù„Ù‡ÙŠØ¯Ø± */
.header{
    background:#ededed;
    height:65px;
    display:flex;
    align-items:center;
    padding:8px;
    box-shadow:0 1px 3px rgba(0,0,0,.25);
}

.avatar{
    width:42px;
    height:42px;
    border-radius:50%;
    background:linear-gradient(45deg,#5fb6e5,#2a83c7);
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    margin-left:10px;
}

.title{
    flex:1;
}
.title b{font-size:17px;}
.title span{font-size:13px;color:gray}

/* Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© */
.chat{
    flex:1;
    overflow-y:auto;
    padding:12px;
    background-image:url("chat_bg.png");
    background-size:cover;
    background-position:center;
}

/* Ø§Ù„ØªØ§Ø±ÙŠØ® */
.date{text-align:center;margin:14px 0;}
.date span{
    background:#a9c39a;
    color:white;
    padding:6px 14px;
    border-radius:14px;
    font-size:13px;
}

/* Ø±Ø³Ø§Ù„Ø© */
.message{
    max-width:75%;
    background:white;
    padding:10px;
    border-radius:14px;
    box-shadow:0 1px 2px rgba(0,0,0,.2);
    margin-bottom:8px;
}

.sender{
    color:#1d6fa5;
    font-weight:bold;
    margin-bottom:5px;
}

/* Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª */
.reactions{
    display:flex;
    gap:8px;
    margin-top:8px;
}

.react{
    background:#f1f1f1;
    padding:4px 10px;
    border-radius:12px;
    cursor:pointer;
    user-select:none;
}

/* Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
.info{
    display:flex;
    justify-content:flex-end;
    align-items:center;
    gap:8px;
    margin-top:6px;
    color:#666;
    font-size:13px;
}

/* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
.bottom{
    background:#f0f0f0;
    padding:8px;
    display:flex;
    align-items:center;
    gap:8px;
}

.join{
    flex:1;
    height:45px;
    border:none;
    border-radius:25px;
    background:#2d8cd3;
    color:white;
    font-size:16px;
    cursor:pointer;
}

.mute{
    flex:1;
    height:45px;
    border:none;
    border-radius:25px;
    background:#dcdcdc;
    font-size:16px;
    cursor:pointer;
    display:none;
}

</style>
</head>

<body>

<!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
<div class="header">
    <div class="avatar" id="avatar">Ø§Ù„</div>
    <div class="title">
        <b id="channelName">Ø§Ù„Ù…Ø·ÙˆØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</b><br>
        <span id="subs">3 Ù…Ø´ØªØ±ÙƒÙŠÙ†</span>
    </div>
</div>

<!-- Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
<div class="chat" id="chatContainer">
    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø³ÙŠÙÙ…Ù„Ø£ Ø¹Ø¨Ø± JavaScript -->
</div>

<!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ -->
<div class="bottom">
    <button class="join" id="joinBtn" onclick="join()">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
    <button class="mute" id="muteBtn" onclick="mute()">ÙƒØªÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
</div>

<script type="module">
    // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
        getDatabase, 
        ref, 
        get, 
        update, 
        onValue, 
        push, 
        set,
        query,
        orderByChild,
        equalTo,
        serverTimestamp,
        increment
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDRCtfuYrEdnuKUsWu_79NC6G_xGLznBJc",
        authDomain: "tttrt-b8c5a.firebaseapp.com",
        databaseURL: "https://tttrt-b8c5a-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "tttrt-b8c5a",
        storageBucket: "tttrt-b8c5a.firebasestorage.app",
        messagingSenderId: "975123752593",
        appId: "1:975123752593:web:e591e930af3a3e29568130"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ù†Ø§Ø© Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· (Ù…Ø«Ù„Ø§Ù‹ ?id=...)
    const urlParams = new URLSearchParams(window.location.search);
    const channelId = urlParams.get('id');

    const avatarEl = document.getElementById('avatar');
    const channelNameEl = document.getElementById('channelName');
    const subsEl = document.getElementById('subs');
    const chatContainer = document.getElementById('chatContainer');
    const joinBtn = document.getElementById('joinBtn');
    const muteBtn = document.getElementById('muteBtn');

    let currentUserId = null;
    let currentChannelData = null;
    let isMember = false;
    let isMuted = false; // Ø³Ù†Ø®Ø²Ù† ÙÙŠ localStorage

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    onAuthStateChanged(auth, (user) => {
        if (!user) {
            window.location.href = 'index.html';
            return;
        }
        currentUserId = user.uid;
        if (!channelId) {
            chatContainer.innerHTML = '<div style="text-align:center; padding:2rem;">Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ù†Ø§Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</div>';
            return;
        }
        loadChannel();
    });

    function loadChannel() {
        const channelRef = ref(database, 'channels/' + channelId);
        onValue(channelRef, async (snapshot) => {
            if (!snapshot.exists()) {
                chatContainer.innerHTML = '<div style="text-align:center; padding:2rem;">Ø§Ù„Ù‚Ù†Ø§Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</div>';
                return;
            }
            currentChannelData = snapshot.val();
            isMember = currentChannelData.members?.includes(currentUserId) || false;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠØ¯Ø±
            channelNameEl.textContent = currentChannelData.name || 'Ø§Ù„Ù‚Ù†Ø§Ø©';
            const memberCount = currentChannelData.members?.length || 1;
            subsEl.textContent = memberCount + ' Ù…Ø´ØªØ±ÙƒÙŠÙ†';
            avatarEl.textContent = (currentChannelData.name || 'Ù‚').charAt(0).toUpperCase();

            // Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªÙ… Ù…Ù† localStorage
            const muteKey = `muted_${channelId}_${currentUserId}`;
            isMuted = localStorage.getItem(muteKey) === 'true';

            // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
            if (isMember) {
                joinBtn.style.display = 'none';
                muteBtn.style.display = 'block';
                muteBtn.textContent = isMuted ? 'Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª' : 'ÙƒØªÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª';
            } else {
                joinBtn.style.display = 'block';
                muteBtn.style.display = 'none';
            }

            // Ø¨Ù†Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            buildChat();
        });
    }

    async function buildChat() {
        // Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ø³ØªØ®Ø¯Ù… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡)
        let chatHtml = '';
        const createdDate = currentChannelData.createdAt ? new Date(currentChannelData.createdAt).toLocaleDateString('ar-EG', { day: 'numeric', month: 'long' }) : '20 ÙØ¨Ø±Ø§ÙŠØ±';
        chatHtml += `<div class="date"><span>${createdDate}</span></div>`;

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø¶ÙˆØ§Ù‹ØŒ Ø£Ø¶Ù Ø±Ø³Ø§Ù„Ø© "Ù„Ù‚Ø¯ Ø§Ù†Ø¶Ù…Ù…Øª"
        if (isMember) {
            chatHtml += `<div style="text-align:center; margin:6px 0;"><span style="background:#a9c39a; color:white; padding:6px 14px; border-radius:14px; font-size:13px;">Ù„Ù‚Ø¯ Ø§Ù†Ø¶Ù…Ù…Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ù†Ø§Ø©</span></div>`;
        }

        chatContainer.innerHTML = chatHtml;

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø¶ÙˆØ§Ù‹ ÙˆØºÙŠØ± Ù…ÙƒØªÙˆÙ… (Ø£Ùˆ Ù…Ø§Ù„ÙƒØ§Ù‹ØŒ Ù„ÙƒÙ† Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø§Ù„Ùƒ Ù…Ø­Ø¯Ø¯ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨Ø³ÙŠØ·)
        if (isMember && !isMuted) {
            loadMessages();
        } else {
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø²Ø§Ø¦Ø±Ø§Ù‹ Ø£Ùˆ Ù…ÙƒØªÙˆÙ…Ø§Ù‹ØŒ Ù„Ø§ ØªØ¸Ù‡Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
            // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©
        }
    }

    async function loadMessages() {
        const messagesRef = ref(database, `channels/${channelId}/messages`);
        const messagesQuery = query(messagesRef, orderByChild('timestamp'));
        const snapshot = await get(messagesQuery);
        
        if (snapshot.exists()) {
            const messages = [];
            snapshot.forEach(child => messages.push({ id: child.key, ...child.val() }));
            // ØªØ±ØªÙŠØ¨ ØªØµØ§Ø¹Ø¯ÙŠ
            messages.sort((a,b) => (a.timestamp || 0) - (b.timestamp || 0));

            for (const msg of messages) {
                const userSnap = await get(ref(database, 'users/' + msg.senderId));
                const sender = userSnap.exists() ? userSnap.val() : { fullName: 'Ù…Ø³ØªØ®Ø¯Ù…', username: '' };
                const senderName = sender.fullName || sender.username || 'Ù…Ø³ØªØ®Ø¯Ù…';
                const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('ar-EG', { hour:'2-digit', minute:'2-digit' }) : '';

                // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‚Ø¯ Ø´ÙˆÙ‡Ø¯Øª Ù…Ù† Ù‚Ø¨Ù„ (Ù†Ø³ØªØ®Ø¯Ù… localStorage Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±)
                if (!localStorage.getItem(`viewed_${msg.id}_${currentUserId}`)) {
                    await update(ref(database, `channels/${channelId}/messages/${msg.id}`), {
                        views: (msg.views || 0) + 1
                    });
                    localStorage.setItem(`viewed_${msg.id}_${currentUserId}`, 'yes');
                }

                // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                const msgDiv = document.createElement('div');
                msgDiv.className = 'message';
                msgDiv.innerHTML = `
                    <div class="sender">${senderName}</div>
                    ${msg.text}
                    <div class="reactions">
                        <div class="react" onclick="react('${msg.id}', 'love')">â¤ï¸ <span id="love_${msg.id}">${msg.love || 0}</span></div>
                        <div class="react" onclick="react('${msg.id}', 'like')">ğŸ‘ <span id="like_${msg.id}">${msg.like || 0}</span></div>
                        <div class="react" onclick="react('${msg.id}', 'wow')">ğŸ¥° <span id="wow_${msg.id}">${msg.wow || 0}</span></div>
                    </div>
                    <div class="info">
                        <span>${msg.views || 0} ğŸ‘</span>
                        <span>${time}</span>
                    </div>
                `;
                chatContainer.appendChild(msgDiv);
            }
        } else {
            // Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø­Ù‚ÙŠÙ‚ÙŠØ©ØŒ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            const defaultMsg = document.createElement('div');
            defaultMsg.className = 'message';
            defaultMsg.innerHTML = `
                <div class="sender">Ø§Ù„Ù…Ø·ÙˆØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</div>
                Ù…Ø±Ø­Ø¨Ø§ Ø¨ÙƒÙ… ÙÙŠ Ù‚Ù†Ø§Ø© Ù…Ø·ÙˆØ± ØªØ·Ø¨ÙŠÙ‚
                <div class="reactions">
                    <div class="react" onclick="react('default', 'love')">â¤ï¸ <span id="love_default">1</span></div>
                    <div class="react" onclick="react('default', 'like')">ğŸ‘ <span id="like_default">1</span></div>
                    <div class="react" onclick="react('default', 'wow')">ğŸ¥° <span id="wow_default">1</span></div>
                </div>
                <div class="info">
                    <span>1 ğŸ‘</span>
                    <span>2:46 Ù…</span>
                </div>
            `;
            chatContainer.appendChild(defaultMsg);
        }
    }

    // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ (Ø³ØªÙƒÙˆÙ† Ù…ØªØ§Ø­Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø§ÙØ°Ø©)
    window.join = async function() {
        if (!currentChannelData) return;
        const members = currentChannelData.members || [];
        if (!members.includes(currentUserId)) {
            members.push(currentUserId);
            await update(ref(database, 'channels/' + channelId), { members: members });
        }
    };

    window.mute = function() {
        const muteKey = `muted_${channelId}_${currentUserId}`;
        isMuted = !isMuted;
        localStorage.setItem(muteKey, isMuted);
        muteBtn.textContent = isMuted ? 'Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª' : 'ÙƒØªÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª';
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        buildChat();
    };

    window.react = async function(messageId, type) {
        const userKey = `reacted_${messageId}_${type}_${currentUserId}`;
        if (localStorage.getItem(userKey)) return; // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±

        const msgRef = ref(database, `channels/${channelId}/messages/${messageId}`);
        const snapshot = await get(msgRef);
        if (snapshot.exists()) {
            const current = snapshot.val()[type] || 0;
            await update(msgRef, { [type]: current + 1 });
            localStorage.setItem(userKey, 'yes');
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
            const span = document.getElementById(`${type}_${messageId}`);
            if (span) span.textContent = current + 1;
        } else if (messageId === 'default') {
            // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (ØºÙŠØ± Ø§Ù„Ù…Ø®Ø²Ù†Ø©)
            const span = document.getElementById(`${type}_default`);
            if (span && !localStorage.getItem(userKey)) {
                span.textContent = parseInt(span.textContent) + 1;
                localStorage.setItem(userKey, 'yes');
            }
        }
    };
</script>
</body>
</html>
