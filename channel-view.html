<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù‚Ù†Ø§Ø©</title>
    <style>
        /* Ø¥Ø¹Ø¯Ø§Ø¯ Ø¹Ø§Ù… */
        body {
            margin: 0;
            font-family: Tahoma, sans-serif;
            background: #d9e5d6;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .header {
            background: #ededed;
            height: 65px;
            display: flex;
            align-items: center;
            padding: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,.25);
        }

        .back {
            font-size: 22px;
            margin-left: 10px;
            cursor: pointer;
        }

        .avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(45deg,#5fb6e5,#2a83c7);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-left: 10px;
        }

        .title {
            flex: 1;
        }

        .title b {
            font-size: 17px;
        }

        .title span {
            font-size: 13px;
            color: gray;
        }

        .menu {
            font-size: 22px;
            cursor: pointer;
        }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© */
        .chat {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            background-image: url("https://i.imgur.com/9v6p0mT.png");
        }

        /* ØªØ§Ø±ÙŠØ® */
        .date {
            text-align: center;
            margin: 14px 0;
        }

        .date span {
            background: #b7c9a8;
            color: #fff;
            padding: 6px 14px;
            border-radius: 14px;
            font-size: 13px;
            display: inline-block;
        }

        /* Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… */
        .system {
            text-align: center;
            margin: 6px 0;
        }

        .system span {
            background: #b7c9a8;
            color: #fff;
            padding: 6px 14px;
            border-radius: 14px;
            font-size: 13px;
        }

        /* ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
        .message {
            max-width: 75%;
            background: #fff;
            padding: 10px;
            border-radius: 14px;
            box-shadow: 0 1px 2px rgba(0,0,0,.2);
            margin-bottom: 8px;
        }

        .sender {
            color: #1d6fa5;
            font-weight: bold;
            margin-bottom: 4px;
        }

        /* Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª */
        .reactions {
            display: flex;
            gap: 10px;
            margin-top: 6px;
            font-size: 14px;
            color: #555;
        }

        .reaction {
            background: #f1f1f1;
            padding: 3px 8px;
            border-radius: 12px;
            cursor: pointer;
        }

        .reaction:hover {
            background: #e0e0e0;
        }

        /* Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
        .info {
            display: flex;
            justify-content: flex-end;
            font-size: 12px;
            color: #777;
            margin-top: 4px;
            gap: 10px;
        }

        /* Ø²Ø± ÙƒØªÙ… Ø§Ù„ØµÙˆØª */
        .mute {
            background: #eaeaea;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 0 10px;
        }

        .mute button {
            width: 80%;
            height: 40px;
            border: none;
            border-radius: 20px;
            background: #fff;
            font-size: 15px;
            cursor: pointer;
        }

        .mute button:hover {
            background: #f5f5f5;
        }

        /* Ø²Ø± Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… (ÙŠØ¸Ù‡Ø± Ù„Ù„Ø²ÙˆØ§Ø±) */
        .join-btn {
            width: 80%;
            height: 40px;
            border: none;
            border-radius: 20px;
            background: #2A6B9C;
            color: white;
            font-size: 15px;
            cursor: pointer;
            margin: 0 auto;
        }

        .join-btn:hover {
            background: #1f4e7a;
        }

        /* Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„ */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #8899aa;
        }
        .error {
            text-align: center;
            padding: 2rem;
            color: #dc3545;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>

    <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± (Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¨Ø± JavaScript) -->
    <div class="header">
        <div class="back" onclick="goBack()">â†</div>

        <div class="avatar" id="avatar"></div>

        <div class="title">
            <b id="channelName">Ø§Ù„Ù…Ø·ÙˆØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</b><br>
            <span id="subscriberCount">3 Ù…Ø´ØªØ±ÙƒÙŠÙ†</span>
        </div>

        <div class="menu" id="settingsMenu" style="display: none;" onclick="openSettings()">â‹®</div>
    </div>

    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© (Ø³ØªÙÙ…Ù„Ø£ Ø¨Ø§Ù„Ø±Ø³Ø§Ø¦Ù„) -->
    <div class="chat" id="chatContainer">
        <div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>

    <!-- Ù…Ù†Ø·Ù‚Ø© Ø²Ø± Ø§Ù„ÙƒØªÙ…/Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… (ØªØ¸Ù‡Ø± Ø­Ø³Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…) -->
    <div class="mute" id="actionBar">
        <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¹Ø¨Ø± JavaScript -->
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ù…Ø§Ù„Ùƒ) -->
    <div id="settingsModal" style="display: none; position: fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000;">
        <div style="background:white; border-radius:20px; padding:2rem; max-width:400px; width:90%;">
            <h3 style="margin-bottom:1rem; color:#1a2b3e;">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚Ù†Ø§Ø©</h3>
            <div style="margin-bottom:1rem;">
                <label style="display:block; margin-bottom:0.3rem; color:#4b5f73;">Ø§Ù„Ø§Ø³Ù…</label>
                <input type="text" id="editName" style="width:100%; padding:0.8rem; border:1px solid #d9e1ec; border-radius:12px;">
            </div>
            <div style="margin-bottom:1rem;">
                <label style="display:block; margin-bottom:0.3rem; color:#4b5f73;">Ø§Ù„ÙˆØµÙ</label>
                <textarea id="editDesc" rows="3" style="width:100%; padding:0.8rem; border:1px solid #d9e1ec; border-radius:12px;"></textarea>
            </div>
            <div style="margin-bottom:1rem;">
                <label style="display:block; margin-bottom:0.3rem; color:#4b5f73;">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                <input type="text" id="editUsername" style="width:100%; padding:0.8rem; border:1px solid #d9e1ec; border-radius:12px;">
            </div>
            <div style="margin-bottom:1rem;">
                <label style="display:block; margin-bottom:0.3rem; color:#4b5f73;">Ø§Ù„Ø®ØµÙˆØµÙŠØ©</label>
                <select id="editPrivacy" style="width:100%; padding:0.8rem; border:1px solid #d9e1ec; border-radius:12px;">
                    <option value="public">Ø¹Ø§Ù…Ø©</option>
                    <option value="private">Ø®Ø§ØµØ©</option>
                </select>
            </div>
            <button onclick="saveSettings()" style="width:100%; padding:0.8rem; background:#2A6B9C; color:white; border:none; border-radius:30px; margin-top:1rem;">Ø­ÙØ¸</button>
            <button onclick="closeSettings()" style="width:100%; padding:0.8rem; background:#6c757d; color:white; border:none; border-radius:30px; margin-top:0.5rem;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            get, 
            update, 
            onValue, 
            push, 
            set,
            query,
            orderByChild,
            equalTo,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDRCtfuYrEdnuKUsWu_79NC6G_xGLznBJc",
            authDomain: "tttrt-b8c5a.firebaseapp.com",
            databaseURL: "https://tttrt-b8c5a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "tttrt-b8c5a",
            storageBucket: "tttrt-b8c5a.firebasestorage.app",
            messagingSenderId: "975123752593",
            appId: "1:975123752593:web:e591e930af3a3e29568130"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ù†Ø§Ø© Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· (Ù…Ø«Ù„Ø§Ù‹ channel-view.html?id=abc123)
        const urlParams = new URLSearchParams(window.location.search);
        const channelId = urlParams.get('id');

        // Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø©
        const avatarDiv = document.getElementById('avatar');
        const channelNameEl = document.getElementById('channelName');
        const subscriberCountEl = document.getElementById('subscriberCount');
        const settingsMenu = document.getElementById('settingsMenu');
        const chatContainer = document.getElementById('chatContainer');
        const actionBar = document.getElementById('actionBar');
        const settingsModal = document.getElementById('settingsModal');
        const editName = document.getElementById('editName');
        const editDesc = document.getElementById('editDesc');
        const editUsername = document.getElementById('editUsername');
        const editPrivacy = document.getElementById('editPrivacy');

        let currentUserId = null;
        let currentChannelData = null;
        let isOwner = false;
        let isMember = false;
        // Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªÙ… Ù…Ø®Ø²Ù†Ø© ÙÙŠ localStorage
        let isMuted = false;

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            currentUserId = user.uid;
            if (!channelId) {
                chatContainer.innerHTML = '<div class="error">Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ù†Ø§Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</div>';
                return;
            }
            loadChannel();
        });

        function loadChannel() {
            const channelRef = ref(database, 'channels/' + channelId);
            onValue(channelRef, async (snapshot) => {
                if (!snapshot.exists()) {
                    chatContainer.innerHTML = '<div class="error">Ø§Ù„Ù‚Ù†Ø§Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</div>';
                    return;
                }
                currentChannelData = snapshot.val();
                isOwner = currentChannelData.createdBy === currentUserId;
                isMember = currentChannelData.members?.includes(currentUserId) || false;

                // Ù‚Ø±Ø§Ø¡Ø© Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªÙ… Ù…Ù† localStorage
                const muteKey = `muted_${channelId}_${currentUserId}`;
                isMuted = localStorage.getItem(muteKey) === 'true';

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠØ¯Ø±
                const channelName = currentChannelData.name || 'Ø§Ù„Ù‚Ù†Ø§Ø©';
                channelNameEl.textContent = channelName;
                const memberCount = currentChannelData.members?.length || 1;
                subscriberCountEl.textContent = `${memberCount} Ù…Ø´ØªØ±ÙƒÙŠÙ†`;

                // Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ù…Ø²ÙŠØ© (Ø­Ø±Ù Ø£ÙˆÙ„ Ù…Ù† Ø§Ù„Ø§Ø³Ù…)
                const initial = channelName.charAt(0).toUpperCase();
                avatarDiv.textContent = initial;

                // Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø·) Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·
                settingsMenu.style.display = isOwner ? 'inline-block' : 'none';

                // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ø­Ø³Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„ÙƒØªÙ…
                renderContent();
            });
        }

        function renderContent() {
            if (!currentChannelData) return;

            // Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ø³Ø§Ù„Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ø¶ÙˆÙ‹Ø§)
            let chatHtml = '';

            if (currentChannelData.createdAt) {
                const createdDate = new Date(currentChannelData.createdAt).toLocaleDateString('ar-EG', { day: 'numeric', month: 'long' });
                chatHtml += `
                    <div class="date"><span>${createdDate}</span></div>
                    <div class="system"><span>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ù†Ø§Ø©</span></div>
                `;
            } else {
                chatHtml += `
                    <div class="date"><span>20 ÙØ¨Ø±Ø§ÙŠØ±</span></div>
                    <div class="system"><span>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ù†Ø§Ø©</span></div>
                `;
            }

            if (isMember) {
                chatHtml += `<div class="system"><span>Ù„Ù‚Ø¯ Ø§Ù†Ø¶Ù…Ù…Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ù†Ø§Ø©</span></div>`;
            }

            chatHtml += `<br>`;

            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø´ØªØ±ÙƒØ§Ù‹ ÙˆØºÙŠØ± Ù…ÙƒØªÙˆÙ… (Ø£Ùˆ Ù…Ø§Ù„Ùƒ)ØŒ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
            if (isOwner || (isMember && !isMuted)) {
                chatContainer.innerHTML = chatHtml;
                loadMessages(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ¹Ø±Ø¶Ù‡Ø§ Ø¯Ø§Ø®Ù„ chatContainer
            } else {
                // Ù„Ù„Ù…Ø´ØªØ±Ùƒ Ø§Ù„Ù…ÙƒØªÙˆÙ… Ø£Ùˆ Ø§Ù„Ø²Ø§Ø¦Ø±ØŒ Ù†Ø¹Ø±Ø¶ ÙÙ‚Ø· Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¯ÙˆÙ† Ø±Ø³Ø§Ø¦Ù„
                chatContainer.innerHTML = chatHtml;
            }

            // ØªØ­Ø¯ÙŠØ¯ Ù…Ø­ØªÙˆÙ‰ Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª (Ø§Ù„Ø£Ø³ÙÙ„)
            renderActionBar();
        }

        async function loadMessages() {
            const messagesRef = ref(database, `channels/${channelId}/messages`);
            const messagesQuery = query(messagesRef, orderByChild('timestamp'));
            const snapshot = await get(messagesQuery);
            
            if (snapshot.exists()) {
                let messages = [];
                snapshot.forEach((child) => {
                    messages.push({ id: child.key, ...child.val() });
                });
                // ØªØ±ØªÙŠØ¨ ØªØµØ§Ø¹Ø¯ÙŠ (Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹)
                messages.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

                for (const msg of messages) {
                    const userSnap = await get(ref(database, `users/${msg.senderId}`));
                    const sender = userSnap.exists() ? userSnap.val() : { fullName: 'Ù…Ø³ØªØ®Ø¯Ù…', username: '' };
                    const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) : '12:00 Ù…';
                    const senderName = sender.fullName || sender.username || 'Ù…Ø³ØªØ®Ø¯Ù…';

                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ chatContainer
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'message';
                    msgDiv.innerHTML = `
                        <div class="sender">${senderName}</div>
                        ${msg.text}
                        <div class="reactions">
                            <div class="reaction" onclick="likeMessage('${msg.id}')">â¤ï¸ ${msg.likes || 0}</div>
                            <div class="reaction" onclick="viewMessage('${msg.id}')">ğŸ‘ï¸ ${msg.views || 0}</div>
                            <div class="reaction">ğŸ”¥ ${msg.popularity || 0}</div>
                        </div>
                        <div class="info">
                            ğŸ‘ ${msg.views || 0} &nbsp; ${time}
                        </div>
                    `;
                    chatContainer.appendChild(msgDiv);
                }
            } else {
                // Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ â†’ Ù†Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                const msgDiv = document.createElement('div');
                msgDiv.className = 'message';
                msgDiv.innerHTML = `
                    <div class="sender">Ø§Ù„Ù…Ø·ÙˆØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</div>
                    Ù…Ø±Ø­Ø¨Ø§ Ø¨ÙƒÙ… ÙÙŠ Ù‚Ù†Ø§Ø© Ù…Ø·ÙˆØ± ØªØ·Ø¨ÙŠÙ‚
                    <div class="reactions">
                        <div class="reaction">â¤ï¸ 1</div>
                        <div class="reaction">ğŸ‘ 1</div>
                        <div class="reaction">ğŸ¥° 1</div>
                    </div>
                    <div class="info">
                        ğŸ‘ 1 &nbsp; 2:46 Ù…
                    </div>
                `;
                chatContainer.appendChild(msgDiv);
            }
        }

        function renderActionBar() {
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø²Ø§Ø¦Ø±Ø§Ù‹ (ØºÙŠØ± Ù…Ø´ØªØ±Ùƒ)
            if (!isMember && !isOwner) {
                actionBar.innerHTML = `<button class="join-btn" onclick="joinChannel()">Ø§Ù†Ø¶Ù…Ø§Ù…</button>`;
            }
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø´ØªØ±ÙƒØ§Ù‹ (ÙˆÙ„ÙŠØ³ Ù…Ø§Ù„ÙƒØ§Ù‹)
            else if (isMember && !isOwner) {
                if (isMuted) {
                    actionBar.innerHTML = `<button onclick="toggleMute()">Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ… Ø§Ù„ØµÙˆØª</button>`;
                } else {
                    actionBar.innerHTML = `<button onclick="toggleMute()">ÙƒØªÙ… Ø§Ù„ØµÙˆØª</button>`;
                }
            }
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø§Ù„ÙƒØ§Ù‹
            else if (isOwner) {
                // Ø§Ù„Ù…Ø§Ù„Ùƒ Ù„Ø§ ÙŠØ±Ù‰ Ø²Ø± ÙƒØªÙ…ØŒ Ø±Ø¨Ù…Ø§ Ù†Ø¹Ø±Ø¶ Ø´ÙŠØ¦Ø§Ù‹ Ø¢Ø®Ø± Ø£Ùˆ Ù†ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹
                actionBar.innerHTML = ''; // Ø£Ùˆ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ù…ØºØ§Ø¯Ø±Ø©ØŸ Ù„ÙƒÙ† Ø§Ù„Ù…Ø§Ù„Ùƒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©.
            }
        }

        // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„
        window.joinChannel = async function() {
            const channelRef = ref(database, 'channels/' + channelId);
            const members = currentChannelData.members || [];
            if (!members.includes(currentUserId)) {
                members.push(currentUserId);
                await update(channelRef, { members: members });
            }
        };

        window.toggleMute = function() {
            const muteKey = `muted_${channelId}_${currentUserId}`;
            isMuted = !isMuted;
            localStorage.setItem(muteKey, isMuted);
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            renderContent();
        };

        window.likeMessage = async function(messageId) {
            const msgRef = ref(database, `channels/${channelId}/messages/${messageId}`);
            const snapshot = await get(msgRef);
            if (snapshot.exists()) {
                const currentLikes = snapshot.val().likes || 0;
                await update(msgRef, { likes: currentLikes + 1 });
            }
        };

        window.viewMessage = async function(messageId) {
            const msgRef = ref(database, `channels/${channelId}/messages/${messageId}`);
            const snapshot = await get(msgRef);
            if (snapshot.exists()) {
                const currentViews = snapshot.val().views || 0;
                await update(msgRef, { views: currentViews + 1 });
            }
        };

        // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        window.openSettings = function() {
            if (!isOwner) return;
            editName.value = currentChannelData.name || '';
            editDesc.value = currentChannelData.description || '';
            editUsername.value = currentChannelData.username || '';
            editPrivacy.value = currentChannelData.privacy || 'public';
            settingsModal.style.display = 'flex';
        };

        window.closeSettings = function() {
            settingsModal.style.display = 'none';
        };

        window.saveSettings = async function() {
            const updates = {
                name: editName.value.trim(),
                description: editDesc.value.trim(),
                privacy: editPrivacy.value
            };
            if (editUsername.value.trim()) {
                updates.username = editUsername.value.trim();
            }
            try {
                await update(ref(database, 'channels/' + channelId), updates);
                alert('ØªÙ… Ø§Ù„Ø­ÙØ¸');
                closeSettings();
            } catch (error) {
                alert('Ø®Ø·Ø£: ' + error.message);
            }
        };

        window.goBack = function() {
            window.location.href = 'app.html';
        };
    </script>
</body>
</html>
