<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ù‚Ù†Ø§Ø©</title>

<style>
body{
margin:0;
font-family:tahoma;
height:100vh;
background:#e5ddd5;
}

/* ===== Ø§Ù„Ù‡ÙŠØ¯Ø± ===== */
.header{
background:#ededed;
padding:10px;
display:flex;
align-items:center;
box-shadow:0 1px 3px rgba(0,0,0,.25);
cursor:pointer;
}
.back{
font-size:24px;
margin-left:10px;
cursor:pointer;
}
.avatar{
width:42px;height:42px;border-radius:50%;
background:#4aa3d8;
display:flex;align-items:center;justify-content:center;
color:white;font-size:18px;margin-left:10px;
background-size:cover;background-position:center;
}
.title{flex:1}
.title b{font-size:17px}
.title span{font-size:13px;color:gray}

/* ===== Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ===== */
#chatPage{
height:100vh;
display:flex;
flex-direction:column;
}

.chat{
flex:1;
overflow:auto;
padding:12px;
background-image:url("chat_bg.png");
background-size:cover;
}

/* Ø±Ø³Ø§Ù„Ø© */
.message{
background:white;
padding:10px;
border-radius:14px;
max-width:75%;
box-shadow:0 1px 2px rgba(0,0,0,.2);
margin-bottom:8px;
}
.sender{color:#1d6fa5;font-weight:bold}

.reactions{display:flex;gap:8px;margin-top:8px}
.react{background:#eee;padding:4px 10px;border-radius:12px;cursor:pointer}

.info{font-size:13px;color:#555;margin-top:6px;display:flex;gap:8px;justify-content:flex-end}

/* Ø²Ø± Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… ÙˆØ§Ù„ÙƒØªÙ… ÙˆØ§Ù„Ù‡Ø¯ÙŠØ© */
.bottom{
background:#f0f0f0;
padding:8px;
display:flex;
gap:8px;
align-items:center;
}
.join, .mute{
flex:1;
height:45px;
border:none;
border-radius:25px;
font-size:16px;
cursor:pointer;
}
.join{background:#2d8cd3;color:white;}
.mute{background:#ddd;display:none;}
.gift-btn{
background:#ff9800;
color:white;
border:none;
border-radius:50%;
width:45px;
height:45px;
font-size:24px;
cursor:pointer;
display:flex;
align-items:center;
justify-content:center;
box-shadow:0 2px 5px rgba(0,0,0,0.2);
transition:transform 0.2s;
}
.gift-btn:hover{
transform:scale(1.1);
background:#f57c00;
}

/* ===== Ø´Ø§Ø´Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù‚Ù†Ø§Ø© ===== */
#infoPage{
display:none;
height:100vh;
background:#f3f3f3;
overflow-y:auto;
}
.cover{
background:white;
text-align:center;
padding:25px;
}
.bigAvatar{
width:120px;height:120px;border-radius:50%;
background:#4aa3d8;margin:auto;
background-size:cover;background-position:center;
display:flex;
align-items:center;
justify-content:center;
color:white;
font-size:40px;
}
.editBtn{
position:absolute;
left:15px;
top:15px;
font-size:22px;
display:none;
cursor:pointer;
}
.box{background:white;margin-top:10px;padding:15px}

/* ===== Ø´Ø§Ø´Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ===== */
#editPage{
display:none;
height:100vh;
background:#f3f3f3;
padding:15px;
overflow-y:auto;
}
input,textarea{
width:100%;
padding:10px;
margin-top:10px;
font-size:16px;
border:1px solid #ccc;
border-radius:6px;
box-sizing:border-box;
}
.save{
background:#2d8cd3;
color:white;
padding:12px;
border-radius:8px;
text-align:center;
margin-top:15px;
cursor:pointer;
}
.loading{
opacity:0.5;
pointer-events:none;
}
</style>
</head>

<body>

<!-- ================= ØµÙØ­Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ================= -->
<div id="chatPage">

<div class="header">
<div class="back" onclick="goBack()">â†</div>
<div class="avatar" id="avatar">Ø§Ù„</div>
<div class="title">
<b id="cname">Ø§Ù„Ù…Ø·ÙˆØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</b><br>
<span id="subs">3 Ù…Ø´ØªØ±ÙƒÙŠÙ†</span>
</div>
<div style="width:24px;"></div>
</div>

<div class="chat" id="chatContainer">
<!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
</div>

<div class="bottom">
<button class="join" id="joinBtn" onclick="joinChannel()">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
<button class="mute" id="muteBtn" onclick="toggleMute()">ÙƒØªÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
<button class="gift-btn" onclick="openGift()">ğŸ</button>
</div>

</div>

<!-- ================= Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù‚Ù†Ø§Ø© ================= -->
<div id="infoPage">

<div class="editBtn" id="editIcon" onclick="openEdit()">âœï¸</div>

<div class="cover">
<div class="bigAvatar" id="bigAvatar"></div>
<h2 id="infoName">Ø§Ù„Ù…Ø·ÙˆØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h2>
<p id="infoDesc">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ</p>
</div>

<div class="box">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†: <span id="infoSubs">3</span></div>

<div class="box" style="margin-top:5px;">
<button onclick="goToChat()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
</div>

</div>

<!-- ================= Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ================= -->
<div id="editPage">

<h2>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ù†Ø§Ø©</h2>

<label>Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø©</label>
<input id="editName" placeholder="Ø§Ù„Ø§Ø³Ù…">

<label>Ø§Ù„ÙˆØµÙ</label>
<textarea id="editDesc" placeholder="Ø§Ù„ÙˆØµÙ"></textarea>

<label>ØµÙˆØ±Ø© Ø§Ù„Ù‚Ù†Ø§Ø©</label>
<input type="file" id="editImg" accept="image/*">

<div class="save" id="saveBtn" onclick="saveChannel()">Ø­ÙØ¸</div>
<div class="save" style="background:#aaa;" onclick="cancelEdit()">Ø¥Ù„ØºØ§Ø¡</div>

</div>

<script type="module">
    // ================= Ø§Ø³ØªÙŠØ±Ø§Ø¯ Firebase =================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
        getDatabase, 
        ref, 
        get, 
        update, 
        onValue, 
        push, 
        set,
        query,
        orderByChild,
        equalTo,
        serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDRCtfuYrEdnuKUsWu_79NC6G_xGLznBJc",
        authDomain: "tttrt-b8c5a.firebaseapp.com",
        databaseURL: "https://tttrt-b8c5a-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "tttrt-b8c5a",
        storageBucket: "tttrt-b8c5a.firebasestorage.app",
        messagingSenderId: "975123752593",
        appId: "1:975123752593:web:e591e930af3a3e29568130"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);
    const storage = getStorage(app);

    // ================= Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø© =================
    const chatPage = document.getElementById('chatPage');
    const infoPage = document.getElementById('infoPage');
    const editPage = document.getElementById('editPage');
    const avatarEl = document.getElementById('avatar');
    const bigAvatarEl = document.getElementById('bigAvatar');
    const cnameEl = document.getElementById('cname');
    const subsEl = document.getElementById('subs');
    const infoNameEl = document.getElementById('infoName');
    const infoDescEl = document.getElementById('infoDesc');
    const infoSubsEl = document.getElementById('infoSubs');
    const joinBtn = document.getElementById('joinBtn');
    const muteBtn = document.getElementById('muteBtn');
    const editIcon = document.getElementById('editIcon');
    const chatContainer = document.getElementById('chatContainer');
    const editName = document.getElementById('editName');
    const editDesc = document.getElementById('editDesc');
    const editImg = document.getElementById('editImg');
    const saveBtn = document.getElementById('saveBtn');

    // ================= Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© =================
    const urlParams = new URLSearchParams(window.location.search);
    const channelId = urlParams.get('id');

    let currentUserId = null;
    let currentChannelData = null;
    let isOwner = false;
    let isMember = false;
    let isMuted = false;

    // ================= Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ =================
    onAuthStateChanged(auth, (user) => {
        if (!user) {
            window.location.href = 'index.html';
            return;
        }
        currentUserId = user.uid;
        if (!channelId) {
            alert('Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ù†Ø§Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            window.location.href = 'app.html';
            return;
        }
        loadChannel();
    });

    // ================= ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ù†Ø§Ø© =================
    function loadChannel() {
        const channelRef = ref(database, 'channels/' + channelId);
        onValue(channelRef, async (snapshot) => {
            if (!snapshot.exists()) {
                alert('Ø§Ù„Ù‚Ù†Ø§Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                window.location.href = 'app.html';
                return;
            }
            currentChannelData = snapshot.val();
            isOwner = currentChannelData.createdBy === currentUserId;
            isMember = currentChannelData.members?.includes(currentUserId) || false;

            const muteKey = `muted_${channelId}_${currentUserId}`;
            isMuted = localStorage.getItem(muteKey) === 'true';

            updateUI();
            loadMessages();
        });
    }

    // ================= ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© =================
    function updateUI() {
        const name = currentChannelData.name || 'Ø§Ù„Ù‚Ù†Ø§Ø©';
        const memberCount = currentChannelData.members?.length || 1;
        const desc = currentChannelData.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ';
        const avatar = currentChannelData.avatar || '';

        cnameEl.textContent = name;
        subsEl.textContent = memberCount + ' Ù…Ø´ØªØ±ÙƒÙŠÙ†';
        if (avatar) {
            avatarEl.style.backgroundImage = `url('${avatar}')`;
            avatarEl.textContent = '';
        } else {
            avatarEl.style.backgroundImage = '';
            avatarEl.textContent = name.charAt(0).toUpperCase();
        }

        infoNameEl.textContent = name;
        infoDescEl.textContent = desc;
        infoSubsEl.textContent = memberCount;
        if (avatar) {
            bigAvatarEl.style.backgroundImage = `url('${avatar}')`;
            bigAvatarEl.textContent = '';
        } else {
            bigAvatarEl.style.backgroundImage = '';
            bigAvatarEl.textContent = name.charAt(0).toUpperCase();
        }

        if (isMember) {
            joinBtn.style.display = 'none';
            muteBtn.style.display = 'block';
            muteBtn.textContent = isMuted ? 'Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª' : 'ÙƒØªÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª';
        } else {
            joinBtn.style.display = 'block';
            muteBtn.style.display = 'none';
        }

        editIcon.style.display = isOwner ? 'block' : 'none';
    }

    // ================= ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ =================
    async function loadMessages() {
        const messagesRef = ref(database, `channels/${channelId}/messages`);
        const messagesQuery = query(messagesRef, orderByChild('timestamp'));
        const snapshot = await get(messagesQuery);

        chatContainer.innerHTML = '';

        if (!isMember || isMuted) return;

        if (snapshot.exists()) {
            const messages = [];
            snapshot.forEach(child => messages.push({ id: child.key, ...child.val() }));
            messages.sort((a,b) => (a.timestamp || 0) - (b.timestamp || 0));

            for (const msg of messages) {
                let senderName = 'Ù…Ø³ØªØ®Ø¯Ù…';
                if (msg.senderId) {
                    const userSnap = await get(ref(database, 'users/' + msg.senderId));
                    if (userSnap.exists()) {
                        const userData = userSnap.val();
                        senderName = userData.fullName || userData.username || 'Ù…Ø³ØªØ®Ø¯Ù…';
                    }
                }
                const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('ar-EG', { hour:'2-digit', minute:'2-digit' }) : '';

                if (!localStorage.getItem(`viewed_${msg.id}_${currentUserId}`)) {
                    await update(ref(database, `channels/${channelId}/messages/${msg.id}`), {
                        views: (msg.views || 0) + 1
                    });
                    localStorage.setItem(`viewed_${msg.id}_${currentUserId}`, 'yes');
                }

                const msgDiv = document.createElement('div');
                msgDiv.className = 'message';
                msgDiv.innerHTML = `
                    <div class="sender">${senderName}</div>
                    ${msg.text}
                    <div class="reactions">
                        <div class="react" onclick="react('${msg.id}', 'love')">â¤ï¸ <span id="love_${msg.id}">${msg.love || 0}</span></div>
                        <div class="react" onclick="react('${msg.id}', 'like')">ğŸ‘ <span id="like_${msg.id}">${msg.like || 0}</span></div>
                        <div class="react" onclick="react('${msg.id}', 'wow')">ğŸ¥° <span id="wow_${msg.id}">${msg.wow || 0}</span></div>
                    </div>
                    <div class="info">
                        <span>ğŸ‘ ${msg.views || 0}</span>
                        <span>${time}</span>
                    </div>
                `;
                chatContainer.appendChild(msgDiv);
            }
        } else {
            const defaultMsg = document.createElement('div');
            defaultMsg.className = 'message';
            defaultMsg.innerHTML = `
                <div class="sender">Ø§Ù„Ù…Ø·ÙˆØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</div>
                Ù…Ø±Ø­Ø¨Ø§ Ø¨ÙƒÙ… ÙÙŠ Ù‚Ù†Ø§Ø© Ù…Ø·ÙˆØ± ØªØ·Ø¨ÙŠÙ‚
                <div class="reactions">
                    <div class="react" onclick="react('default', 'love')">â¤ï¸ <span id="love_default">1</span></div>
                    <div class="react" onclick="react('default', 'like')">ğŸ‘ <span id="like_default">1</span></div>
                    <div class="react" onclick="react('default', 'wow')">ğŸ¥° <span id="wow_default">1</span></div>
                </div>
                <div class="info">
                    <span>ğŸ‘ 1</span>
                    <span>2:46 Ù…</span>
                </div>
            `;
            chatContainer.appendChild(defaultMsg);
        }
    }

    // ================= Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ =================
    window.react = async function(messageId, type) {
        const userKey = `reacted_${messageId}_${type}_${currentUserId}`;
        if (localStorage.getItem(userKey)) return;

        if (messageId === 'default') {
            const span = document.getElementById(`${type}_default`);
            if (span) {
                span.textContent = parseInt(span.textContent) + 1;
                localStorage.setItem(userKey, 'yes');
            }
            return;
        }

        const msgRef = ref(database, `channels/${channelId}/messages/${messageId}`);
        const snapshot = await get(msgRef);
        if (snapshot.exists()) {
            const current = snapshot.val()[type] || 0;
            await update(msgRef, { [type]: current + 1 });
            localStorage.setItem(userKey, 'yes');
            const span = document.getElementById(`${type}_${messageId}`);
            if (span) span.textContent = current + 1;
        }
    };

    window.joinChannel = async function() {
        if (!currentChannelData) return;
        const members = currentChannelData.members || [];
        if (!members.includes(currentUserId)) {
            members.push(currentUserId);
            await update(ref(database, 'channels/' + channelId), { members: members });
        }
    };

    window.toggleMute = function() {
        const muteKey = `muted_${channelId}_${currentUserId}`;
        isMuted = !isMuted;
        localStorage.setItem(muteKey, isMuted);
        muteBtn.textContent = isMuted ? 'Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª' : 'ÙƒØªÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª';
        loadMessages();
    };

    // ================= Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù‡Ø¯ÙŠØ© =================
    window.openGift = function() {
        window.location.href = 'gift.html';
    };

    // ================= Ø§Ù„ØªÙ†Ù‚Ù„ =================
    window.openInfo = function() {
        chatPage.style.display = 'none';
        infoPage.style.display = 'block';
        editPage.style.display = 'none';
    };

    window.goToChat = function() {
        chatPage.style.display = 'flex';
        infoPage.style.display = 'none';
        editPage.style.display = 'none';
    };

    window.openEdit = function() {
        if (!isOwner) return;
        editName.value = currentChannelData.name || '';
        editDesc.value = currentChannelData.description || '';
        editPage.style.display = 'block';
        infoPage.style.display = 'none';
        chatPage.style.display = 'none';
    };

    window.cancelEdit = function() {
        editPage.style.display = 'none';
        infoPage.style.display = 'block';
    };

    // ================= Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ø¹ Ø§Ù„ØµÙˆØ±Ø© =================
    window.saveChannel = async function() {
        const newName = editName.value.trim();
        const newDesc = editDesc.value.trim();
        if (!newName) {
            alert('Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨');
            return;
        }

        saveBtn.classList.add('loading');
        saveBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

        try {
            const updates = {
                name: newName,
                description: newDesc
            };

            const file = editImg.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    alert('Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ØŒ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª');
                    saveBtn.classList.remove('loading');
                    saveBtn.textContent = 'Ø­ÙØ¸';
                    return;
                }

                const timestamp = Date.now();
                const fileRef = storageRef(storage, `channel_avatars/${channelId}/${timestamp}_${file.name}`);
                await uploadBytes(fileRef, file);
                const downloadURL = await getDownloadURL(fileRef);
                updates.avatar = downloadURL;
            }

            await update(ref(database, 'channels/' + channelId), updates);
            alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­');
            editPage.style.display = 'none';
            infoPage.style.display = 'block';
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸:', error);
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: ' + error.message);
        } finally {
            saveBtn.classList.remove('loading');
            saveBtn.textContent = 'Ø­ÙØ¸';
        }
    };

    window.goBack = function() {
        window.location.href = 'app.html';
    };

    // Ø±Ø¨Ø· Ø§Ù„Ù‡ÙŠØ¯Ø± Ø¨ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
    document.querySelector('.header').onclick = openInfo;

    // Ø¨Ø¯Ø¡ Ø¨Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    goToChat();
</script>
</body>
</html>
