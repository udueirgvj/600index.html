<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙˆØ§ØµÙ„ - Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        body {
            background: #f0f2f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: #2A6B9C;
            color: white;
            padding: 1rem;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
        }
        .main-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }
        .chat-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .chat-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer;
        }
        .chat-item .avatar {
            width: 50px;
            height: 50px;
            background: #2A6B9C;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        .chat-item .details {
            flex: 1;
        }
        .chat-item .details h4 {
            font-size: 1rem;
            color: #1a2b3e;
        }
        .chat-item .details p {
            font-size: 0.85rem;
            color: #7f8fa4;
        }
        .chat-item .time {
            font-size: 0.75rem;
            color: #8899aa;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #8899aa;
        }
        .error {
            text-align: center;
            padding: 2rem;
            color: #dc3545;
            background: #f8d7da;
            border-radius: 8px;
            margin: 1rem;
        }
        .btn {
            background: #2A6B9C;
            color: white;
            border: none;
            border-radius: 30px;
            padding: 0.8rem 2rem;
            font-size: 1rem;
            cursor: pointer;
            margin: 1rem auto;
            display: block;
        }
    </style>
</head>
<body>
    <div class="header">
        ØªÙˆØ§ØµÙ„
    </div>

    <div class="main-content">
        <div id="chatList" class="chat-list">
            <div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª...</div>
        </div>
    </div>

    <!-- Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø¤Ù‚Øª -->
    <button class="btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            get, 
            onValue,
            query,
            orderByChild,
            limitToLast
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ğŸ”¥ ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙØ§ØªÙŠØ­
        const firebaseConfig = {
            apiKey: "AIzaSyDRCtfuYrEdnuKUsWu_79NC6G_xGLznBJc",
            authDomain: "tttrt-b8c5a.firebaseapp.com",
            databaseURL: "https://tttrt-b8c5a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "tttrt-b8c5a",
            storageBucket: "tttrt-b8c5a.firebasestorage.app",
            messagingSenderId: "975123752593",
            appId: "1:975123752593:web:e591e930af3a3e29568130"
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        const chatListDiv = document.getElementById('chatList');
        let currentUserId = null;

        // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            currentUserId = user.uid;
            console.log('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ:', currentUserId);
            loadChats();
        });

        // Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
        function loadChats() {
            const chatsRef = ref(database, 'chats');
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… onValue Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
            onValue(chatsRef, async (snapshot) => {
                console.log('ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                try {
                    if (!snapshot.exists()) {
                        chatListDiv.innerHTML = '<div class="loading">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø¨Ø¹Ø¯</div>';
                        return;
                    }

                    const userChats = [];
                    
                    // Ø­Ù„Ù‚Ø© Ø¹Ø¨Ø± ÙƒÙ„ Ù…Ø­Ø§Ø¯Ø«Ø©
                    snapshot.forEach((childSnapshot) => {
                        const chatId = childSnapshot.key;
                        console.log('Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:', chatId);
                        
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                        if (chatId.includes(currentUserId)) {
                            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ø®Ø±
                            const parts = chatId.split('_');
                            const otherUserId = parts.find(id => id !== currentUserId);
                            if (otherUserId) {
                                userChats.push({
                                    chatId: chatId,
                                    otherUserId: otherUserId
                                });
                            }
                        }
                    });

                    console.log('Ø¹Ø¯Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', userChats.length);

                    if (userChats.length === 0) {
                        chatListDiv.innerHTML = '<div class="loading">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø¨Ø¹Ø¯</div>';
                        return;
                    }

                    // Ø¨Ù†Ø§Ø¡ HTML Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
                    let html = '';
                    for (const chat of userChats) {
                        try {
                            // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ø®Ø±
                            const userSnap = await get(ref(database, 'users/' + chat.otherUserId));
                            if (!userSnap.exists()) continue;
                            
                            const userData = userSnap.val();
                            const displayName = userData.fullName || userData.username || 'Ù…Ø³ØªØ®Ø¯Ù…';
                            
                            // Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©
                            const messagesRef = ref(database, `chats/${chat.chatId}/messages`);
                            const lastMsgQuery = query(messagesRef, orderByChild('timestamp'), limitToLast(1));
                            const lastMsgSnap = await get(lastMsgQuery);
                            
                            let lastMsg = 'Ø§Ø¶ØºØ· Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©';
                            let lastTime = '';
                            
                            if (lastMsgSnap.exists()) {
                                lastMsgSnap.forEach((msg) => {
                                    const msgData = msg.val();
                                    lastMsg = msgData.text || 'Ø±Ø³Ø§Ù„Ø©';
                                    if (msgData.timestamp) {
                                        lastTime = new Date(msgData.timestamp).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
                                    }
                                });
                            }

                            const initial = displayName.charAt(0).toUpperCase();
                            html += `
                                <div class="chat-item" onclick="goToChat('${chat.otherUserId}', '${displayName}', '${userData.username || ''}')">
                                    <div class="avatar">${initial}</div>
                                    <div class="details">
                                        <h4>${displayName}</h4>
                                        <p>${lastMsg}</p>
                                    </div>
                                    <div class="time">${lastTime}</div>
                                </div>
                            `;
                        } catch (err) {
                            console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø­Ø§Ø¯Ø«Ø©:', err);
                        }
                    }

                    chatListDiv.innerHTML = html || '<div class="loading">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø¨Ø¹Ø¯</div>';
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ loadChats:', error);
                    chatListDiv.innerHTML = `<div class="error">Ø­Ø¯Ø« Ø®Ø·Ø£: ${error.message}</div>`;
                }
            }, (error) => {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª:', error);
                chatListDiv.innerHTML = `<div class="error">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}</div>`;
            });
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        window.goToChat = function(uid, name, username) {
            if (!uid) return;
            window.location.href = `chat.html?uid=${uid}&name=${encodeURIComponent(name)}&username=${username}`;
        };

        // Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        window.logout = async function() {
            await signOut(auth);
        };
    </script>
</body>
</html>
