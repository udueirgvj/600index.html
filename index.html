<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDRCtfuYrEdnuKUsWu_79N0",
    authDomain: "tttrt-b8c5a.firebaseapp.com",
    databaseURL: "https://tttrt-b8c5a-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "tttrt-b8c5a",
    storageBucket: "tttrt-b8c5a.appspot.com",
    messagingSenderId: "975123752593",
    appId: "1:975123752593:web:e591e930af101968875560"
  };
  // بدء تشغيل فايربيس
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
</script>

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق الدردشة العالمي</title>
    <style>
        :root { --primary: #0088cc; --bg: #e6eee0; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .hidden { display: none !important; }
        
        /* شاشة الدخول */
        #login-page { background: white; padding: 30px; margin: auto; border-radius: 20px; width: 85%; max-width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        button { width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; }

        /* الشاشة الرئيسية */
        #chat-app { display: flex; flex-direction: column; height: 100vh; }
        header { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        /* البحث والمستخدمين */
        #search-box { background: white; padding: 10px; display: flex; gap: 5px; border-bottom: 1px solid #ddd; }
        #results { padding: 10px; flex: 1; overflow-y: auto; }
        .user-card { background: white; padding: 10px; border-radius: 10px; display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .user-card img { width: 45px; height: 45px; border-radius: 50%; }

        /* نافذة الدردشة الخاصة */
        #private-window { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; flex-direction: column; z-index: 100; }
        #msg-list { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 10px; border-radius: 10px; max-width: 70%; }
        .sent { background: #effdde; align-self: flex-end; }
        .received { background: white; align-self: flex-start; }
        .input-area { background: white; padding: 15px; display: flex; gap: 10px; }
    </style>
</head>
<body>

    <div id="login-page">
        <h2>أهلاً بك في الدردشة</h2>
        <input type="text" id="name" placeholder="الاسم الكامل">
        <input type="text" id="user" placeholder="اسم المستخدم (4 حروف فأكثر)">
        <input type="text" id="pic" placeholder="رابط صورتك">
        <button onclick="login()">دخول الآن</button>
    </div>

    <div id="chat-app" class="hidden">
        <header>
            <span id="me">...</span>
            <button onclick="logout()" style="width:auto; padding:5px;">خروج</button>
        </header>
        
        <div id="search-box">
            <input type="text" id="s-input" placeholder="ابحث عن يوزر...">
            <button onclick="search()" style="width:auto;">بحث</button>
        </div>
        
        <div id="results"></div>

        <div id="private-window" class="hidden">
            <div style="background:#eee; padding:10px; display:flex; justify-content:space-between;">
                <span>دردشة مع: <b id="chat-with"></b></span>
                <button onclick="closeChat()">إغلاق</button>
            </div>
            <div id="msg-list"></div>
            <div class="input-area">
                <input type="text" id="m-text" placeholder="اكتب رسالتك...">
                <button onclick="sendMsg()" style="width:auto;">إرسال</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // إعداداتك من الصورة
        const firebaseConfig = {
            apiKey: "AIzaSyDRCtfuYrEdnuKUsWu_79N0",
            authDomain: "tttrt-b8c5a.firebaseapp.com",
            databaseURL: "https://tttrt-b8c5a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "tttrt-b8c5a",
            storageBucket: "tttrt-b8c5a.appspot.com",
            messagingSenderId: "975123752593",
            appId: "1:975123752593:web:e591e930af101968875560"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let myData = JSON.parse(localStorage.getItem('chat_user'));
        let targetUser = null;
        let chatRef = null;

        // الدخول التلقائي إذا كان مسجلاً سابقاً
        if(myData) { showApp(); }

        function login() {
            const uName = document.getElementById('name').value;
            const uUser = document.getElementById('user').value.toLowerCase().trim();
            const uPic = document.getElementById('pic').value || "https://cdn-icons-png.flaticon.com/512/149/149071.png";

            if(uUser.length < 4) return alert("اليوزر قصير!");

            const id = "ID-" + Math.floor(Math.random()*9000);
            myData = { id, name: uName, username: uUser, pic: uPic };
            
            // حفظ في Firebase وفي المتصفح
            db.ref('users/' + id).set(myData);
            localStorage.setItem('chat_user', JSON.stringify(myData));
            showApp();
        }

        function showApp() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('chat-app').classList.remove('hidden');
            document.getElementById('me').innerText = myData.name;
        }

        function search() {
            const q = document.getElementById('s-input').value.toLowerCase().trim();
            db.ref('users').orderByChild('username').equalTo(q).once('value', s => {
                const res = document.getElementById('results');
                res.innerHTML = "";
                s.forEach(child => {
                    const u = child.val();
                    if(u.id === myData.id) return;
                    res.innerHTML += `
                        <div class="user-card">
                            <img src="${u.pic}">
                            <div style="flex:1"><b>${u.name}</b><br>@${u.username}</div>
                            <button onclick="openChat('${u.id}', '${u.name}')" style="width:auto; background:#28a745;">مراسلة</button>
                        </div>`;
                });
            });
        }

        function openChat(tid, tname) {
            targetUser = tid;
            document.getElementById('chat-with').innerText = tname;
            document.getElementById('private-window').classList.remove('hidden');
            
            const cid = myData.id < tid ? myData.id+"_"+tid : tid+"_"+myData.id;
            if(chatRef) chatRef.off();
            document.getElementById('msg-list').innerHTML = "";
            
            chatRef = db.ref('chats/' + cid);
            chatRef.on('child_added', s => {
                const m = s.val();
                const d = document.createElement('div');
                d.className = `msg ${m.f === myData.id ? 'sent' : 'received'}`;
                d.innerText = m.t;
                document.getElementById('msg-list').appendChild(d);
                document.getElementById('msg-list').scrollTop = 99999;
            });
        }

        function sendMsg() {
            const t = document.getElementById('m-text').value;
            if(t && chatRef) {
                chatRef.push({ f: myData.id, t: t });
                document.getElementById('m-text').value = "";
            }
        }

        function closeChat() { document.getElementById('private-window').classList.add('hidden'); }
        function logout() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>

